<?xml version="1.0" encoding="UTF-8"?>
<sequence name="PeopleSoftAddIP" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <property name="DISABLE_CHUNKING" value="true" scope="axis2"/>
    <header action="remove" description="delete sm_user" name="sm_user" scope="transport"/>
    <header action="remove" description="delete principal_net_id" name="principal_net_id" scope="transport"/>
    <header action="remove" description="delete principal_byu_id" name="principal_byu_id" scope="transport"/>
    <header action="remove" description="delete principal_id" name="principal_id" scope="transport"/>
    <header action="remove" description="delete actor_id" name="actor_id" scope="transport"/>
    <header action="remove" description="delete actor_byu_id" name="actor_byu_id" scope="transport"/>
    <header action="remove" description="delete actor_net_id" name="actor_net_id" scope="transport"/>
    <class description="decode JWT Header" name="edu.byu.wso2.apim.extensions.JWTDecoder"/>
    <property description="getActorNetId"
              expression="get-property('transport','Acting-For')"
              name="actorNetId" scope="default" type="STRING"/>
    <property name="rest_url_postfix" expression="get-property('axis2', 'REST_URL_POSTFIX')"/>
    <class description="denormalize" name="edu.byu.wso2.apim.extensions.DenormalizePeopleSoftURL">
        <property name="PropertyName" value="rest_url_postfix"/>
    </class>
    <property name="REST_URL_POSTFIX" expression="get-property('rest_url_postfix')" scope="axis2" type="STRING"/>

    <filter description="Actor Support" regex="false" source="boolean(get-property('transport','Acting-For'))">
        <then>
            <filter description="Has resource owner" regex="APPLICATION_USER" source="get-property('usertype')">
                <then>
                    <property description="add_RO_SMUserHeader"
                              expression="get-property('resourceowner_net_id')"
                              name="sm_user" scope="transport" type="STRING"/>
                    <property description="add_RO_BYUIdHeader"
                              expression="get-property('resourceowner_byu_id')"
                              name="principal_byu_id" scope="transport" type="STRING"/>
                    <property description="add_RO_NetIdHeader"
                              expression="get-property('resourceowner_net_id')"
                              name="principal_net_id" scope="transport" type="STRING"/>
                    <property description="add_RO_PersonIdHeader"
                              expression="get-property('resourceowner_person_id')"
                              name="principal_id" scope="transport" type="STRING"/>
                </then>
                <else>
                    <property description="add_CLIENT_SMUserHeader"
                              expression="get-property('client_net_id')" name="sm_user"
                              scope="transport" type="STRING"/>
                    <property description="add_CLIENT_BYUIdHeader"
                              expression="get-property('client_byu_id')"
                              name="principal_byu_id" scope="transport" type="STRING"/>
                    <property description="add_CLIENT_NetIdHeader"
                              expression="get-property('client_net_id')"
                              name="principal_net_id" scope="transport" type="STRING"/>
                    <property description="add_CLIENT_PersonIdHeader"
                              expression="get-property('client_person_id')"
                              name="principal_id" scope="transport" type="STRING"/>
                </else>
            </filter>
        </then>
        <else>
            <class description="check actor permissions" name="edu.byu.wso2.apim.extensions.CheckActorPermissions">
                <property name="ResultPropertyName" value="canUseActor"/>
                <property name="PRODsName" value="jdbc/BYUPRODB"/>
            </class>
            <filter description="Actor Use denied" regex="false" source="boolean(get-property('canUseActor'))">
                <then>
                    <!-- Set properties to make response -->
                    <header name="To" action="remove"/>
                    <property name="RESPONSE" value="true"/>
                    <property name="NO_ENTITY_BODY" scope="axis2" action="remove"/>

                    <payloadFactory description="set error message body" media-type="xml">
                        <format>
                            <am:fault xmlns:am="http://wso2.org/apimanager">
                                <am:code>BYU-100</am:code>
                                <am:type>Status report</am:type>
                                <am:message>Acting-For Error</am:message>
                                <am:description>Client application is not authorized to use Acting-For header
                                </am:description>
                            </am:fault>
                        </format>
                        <args/>
                    </payloadFactory>
                    <property description="Set 403 return code" name="HTTP_SC"
                              scope="axis2" type="STRING" value="403"/>
                    <send description="Send error response"/>
                </then>
                <else/>
            </filter>
            <property description="add_CLIENT_BYUIdHeader"
                      expression="get-property('client_byu_id')"
                      name="principal_byu_id" scope="transport" type="STRING"/>
            <property description="add_CLIENT_NetIdHeader"
                      expression="get-property('client_net_id')"
                      name="principal_net_id" scope="transport" type="STRING"/>
            <property description="add_CLIENT_PersonIdHeader"
                      expression="get-property('client_person_id')"
                      name="principal_id" scope="transport" type="STRING"/>
            <property description="addActorNetIdHeader"
                      expression="get-property('actorNetId')" name="actor_net_id"
                      scope="transport" type="STRING"/>
            <property description="addActorSMUserHeader"
                      expression="get-property('actorNetId')" name="sm_user"
                      scope="transport" type="STRING"/>
            <class description="LookupActorIdentifiers" name="edu.byu.wso2.apim.extensions.BYUIdentifiersLookup">
                <property name="DsName" value="jdbc/BYUPRODB"/>
                <property name="PropertyPrefix" value="actor"/>
                <property name="NetIdPropertyToUse" value="actorNetId"/>
            </class>
            <property description="addActorBYUIdHeader"
                      expression="get-property('actorBYUId')" name="actor_byu_id"
                      scope="transport" type="STRING"/>
            <property description="addActorPersonIdHeader"
                      expression="get-property('actorPersonId')" name="actor_id"
                      scope="transport" type="STRING"/>
        </else>
    </filter>
    <property description="get X-Forwarded-For"
              expression="get-property('transport','x-forwarded-for')"
              name="xForwardedFor" scope="default" type="STRING"/>
    <property name="JSON-Payload" expression="json-eval($.)"/>
    <script language="js">
        <![CDATA[
            var ipaddress = mc.getProperty("xForwardedFor");
            var payload_string = mc.getProperty("JSON-Payload");
            var payload = JSON.parse(payload_string);
            if (payload.hasOwnProperty("timesheet")) {
            if (payload.timesheet.hasOwnProperty("punch")) {
            payload.timesheet.punch.internet_address = ipaddress;
            }
            }
            mc.setPayloadJSON(payload);
        ]]>
    </script>
    <header action="remove" name="x-forwarded-for" scope="transport"/>
</sequence>